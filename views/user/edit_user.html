{% extends 'layout/application.html' %}
{% block content %}

<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/keyboard.css') }}">
<script src="{{url_for('static', filename='javascript/keyboard.js')}}" defer></script>
<script src="{{url_for('static', filename='javascript/keyboard_init.js')}}" defer></script>
<script src="{{url_for('static', filename='javascript/paginate.min.js')}}"></script>

<h1>Edit User</h1>
<div style="width: 95%; margin-left:auto; margin-right:auto; height: 85%; overflow: auto; text-align:left;">
  <form id="editUserForm" method="POST" action="/user/{{ user.username}}/edit">

        <!-- Tab 1: User Details -->
        <div class="tab">
            <h2>User Details</h2>
            <h3>Full Name</h3>
            <input type="text" placeholder="Full name" name="name" id="input1" class="input" value="{{ user.name }}" autocomplete="on" required style="width: 90%; font-size: 18pt; border-radius: 5px; height: 7vh;">
            <h3>Username</h3>
            <input type="text" placeholder="Username" name="username" id="input2" class="input" value="{{ user.username }}" autocomplete="on" required style="width: 90%; font-size: 18pt; border-radius: 5px; height: 7vh;">
            <div class="simple-keyboard" style="width: 99%; border: 1px solid silver;margin-top: 5vh;"></div>
        </div>

        <!-- Tab 2: User Role -->
        <div class="tab">
            <h2>User Role</h2>
            {% set user_roles = {
                'doc': ['Doctor', 'Clinical Officer'],  
                'nurse': ['Nurse'],
                'student': ['Student']
            } %}
            <ul>
                {% for role, labels in user_roles.items() %}
                    {% for label in labels %}
                        <li>
                            <input type="radio" 
                            id="role_{{ role }}_{{ label | lower | replace(' ', '_') }}" 
                            value="{{ label }}" 
                            name="role"
                            {% if user.role == label %}checked{% endif %} 
                            required
                            autocomplete="off"
                            onchange="filterDesignations('{{ role }}')">
                     <label for="role_{{ role }}_{{ label | lower | replace(' ', '_') }}">{{ label }}</label>
                     
                            <div class="check"></div>
                        </li>
                    {% endfor %}
                {% endfor %}
            </ul>
        </div>
        
        <div class="tab">
            <h2>User Designation</h2>
            {% set user_designation = {
                'doc': ['Clinical Officer', 'Consultant', 'Intern', 'Registrar', 'Visiting Doctor'],
                'nurse': ['Matron', 'Nurse in charge', 'Nurse'],
                'student': ['Medical Student', 'Nursing Student', 'Clinical Officer Student']
            } %}
            <ul>
                {% for role, designations in user_designation.items() %}
                    {% for designation in designations %}
                        <li data-id="{{ role }}" name="designationOptions">
                            <input type="radio" 
   id="designation_{{ role }}_{{ designation | lower | replace(' ', '_') }}" 
   value="{{ designation }}" 
   name="designation" 
   {% if user.designation == designation %}checked{% endif %} 
   autocomplete="off"
   required 
   onchange="filterAllocation('{{ role }}')">
<label for="designation_{{ role }}_{{ designation | lower | replace(' ', '_') }}">{{ designation }}</label>

                            <div class="check"></div>
                        </li>
                    {% endfor %}
                {% endfor %}
            </ul>
        </div>
        
        <div class="tab">
            <h2>Department</h2>
            {% set user_department = ['Medical', 'Ethel Mutharika', 'Oncology', 'Surgery', 'Pediatrics'] %}
            <ul>
                {% for department in user_department %}
                    <li>
                        <input type='radio' id='{{ department | lower | replace(" ", "_") }}' value='{{ department }}'  {% if user.department|lower == department|lower %}checked{% endif %}
                        name='department' required autocomplete="off" onclick='showWards("{{ department }}")'>
                        <label for='{{ department | lower | replace(" ", "_") }}'>{{ department }}</label>
                        <div class='check'></div>
                    </li>
                {% endfor %}
            </ul>
        </div>
        

                
{% set designation_allocation = {
'Clinical Officer': 'teams',
'Consultant': 'teams',
'Intern': 'teams',
'Registrar': 'teams',
'Visiting Doctor': 'teams',
'Medical Student': 'teams',
'Clinical Officer Student': 'teams',
'Nursing Student': 'wards',
'Nurse': 'wards',
'Nurse in charge': 'wards',
'Matron': 'wards'
} %}

{% set departments_info = {
    'Medical': {
        'teams': [
            {'value': 'OPD', 'label': 'OPD'},
            {'value': 'Short Stay', 'label': 'Short Stay'},
            {'value': 'A', 'label': 'Team A'},
            {'value': 'B', 'label': 'Team B'},
            {'value': 'C', 'label': 'Team C'},
            {'value': 'D', 'label': 'Team D'}
        ],
        'wards': [
            {'value': 'OPD2', 'label': 'OPD2'},
            {'value': 'MSS', 'label': 'MSS'},
            {'value': '4A', 'label': '4A'},
            {'value': '4B', 'label': '4B'},
            {'value': 'MHDU', 'label': 'MHDU'},
            {'value': 'DIALYSIS UNIT', 'label': 'DIALYSIS UNIT'}
        ]
    },
    'Surgery': {
        'teams': [
            {'value': '1', 'label': 'Unit 1'},
            {'value': '2', 'label': 'Unit 2'},
            {'value': 'PAEDS SURGERY', 'label': 'Paeds Surgery'},
            {'value': 'PLASTIC SURGERY', 'label': 'Plastic Surgery'},
            {'value': 'NEUROLOGY', 'label': 'Neurology'},
            {'value': 'UROLOGY', 'label': 'Urology'},
            {'value': 'ENT', 'label': 'ENT'}
        ],
        'wards': [
            {'value': 'CASUALTY', 'label': 'Casualty'},
            {'value': '1A', 'label': '1A'},
            {'value': '1B', 'label': '1B'},
            {'value': '2B', 'label': '2B'},
            {'value': '3A', 'label': '3A'},
            {'value': '3B', 'label': '3B'},
            {'value': 'SHDU', 'label': 'SHDU'},
            {'value': 'THEATRE', 'label': 'Theatre'}
        ]
    },
    'Oncology': {
        'teams': [
        {'value': 'A', 'label': 'Team A'},
        {'value': 'B', 'label': 'Team B'},
        {'value': 'C', 'label': 'Team C'}
        ],
        'wards': [
        {'value': 'ICU', 'label': 'ICU'},
        {'value': 'OPD1', 'label': 'OPD1'},
        {'value': 'EYE', 'label': 'EYE'},
        {'value': 'DENTAL', 'label': 'DENTAL'}
        ]
    },
    'Pediatrics': {
        'teams': [
        {'value': 'Pediatrics', 'label': 'Pediatrics'}
        ],
        'wards': [
        {'value': 'UNDER 5', 'label': 'UNDER 5'},
        {'value': 'CWA', 'label': 'CWA'},
        {'value': 'CWB', 'label': 'CWB'},
        {'value': 'CWC', 'label': 'CWC'},
        {'value': 'CW HDU', 'label': 'CW HDU'}
       ]
    },
    'Ethel Mutharika': {
        'teams': [
        {'value': '1', 'label': 'Unit 1'},
        {'value': '2', 'label': 'Unit 2'},
        {'value': '3', 'label': 'Unit 3'},
        {'value': '4', 'label': 'Unit 4'}
        ],
        'wards': [
        {'value': 'LABOUR', 'label': 'LABOUR'},
        {'value': 'POSTNATAL WARD', 'label': 'POSTNATAL WARD'},
        {'value': 'ANTENATAL WARD', 'label': 'ANTENATAL WARD'},
        {'value': 'EM OPD', 'label': 'EM OPD'},
        {'value': 'EM NURSERY', 'label': 'EM NURSERY'},
        {'value': 'EMHDU', 'label': 'EMHDU'},
        {'value': 'GYNAE', 'label': 'GYNAE'}
       ]
    }
} %}


                <div class="tab">
                    <h2>Allocation</h2>
                    <div id="allocationContainer">
                        <ul>

                        </ul>
                    </div>
                </div>


        <div style="border: 1px solid silver; margin-top: 1vh;">
            <table style="width:100%;">
                <tr>
                    <td>
                        <a href="/users" title="Cancel"><button type="button" class="modalNVButton red">Cancel</button></a>
                    </td>
                    <td style="text-align: center;">
                        <span class="step"></span>
                        <span class="step"></span>
                        <span class="step"></span>
                        <span class="step"></span>
                    </td>
                    <td style="text-align: right">
                        <button type="button" id="prevBtn" class="modalNVButton" onclick="nextPrev(-1)">Previous</button>
                        <button type="button" id="nextBtn" class="modalNVButton green" onclick="nextPrev(1)">Next</button>
                    </td>
                </tr>
            </table>
        </div>
    </form>
</div>

   
<script type="text/javascript">
    let currentTab = 0;
    showTab(currentTab);

    function showEditUserDialog() {
        window.location = '{{ request.url.split("?")[0] }}#userModal';
    }

    function showTab(n) {
        const tabs = document.getElementsByClassName('tab');
        for (let i = 0; i < tabs.length; i++) {
            tabs[i].style.display = 'none';
        }
        tabs[n].style.display = 'block';

        if (n === 0) {
            document.getElementById('prevBtn').style.display = 'none';
        } else {
            document.getElementById('prevBtn').style.display = 'inline';
        }

        if (n === tabs.length - 1) {
            document.getElementById('nextBtn').innerHTML = 'Save';
        } else {
            document.getElementById('nextBtn').innerHTML = 'Next';
        }
    }

    function nextPrev(n) {
        const tabs = document.getElementsByClassName('tab');
        if (n === 1 && !validateForm()) return false;
        tabs[currentTab].style.display = 'none';
        currentTab = currentTab + n;

        if (currentTab >= tabs.length) {
            document.getElementById('editUserForm').submit();
            return false;
        }

        showTab(currentTab);

       /*const selectedRole = document.querySelector('input[type="radio"][name="role"]:checked');

        if (selectedRole.id == "doc"){
            filterDesignations("doc")
        } else if (selectedRole.id == "nurse") {
            filterDesignations("nurse")
        } else if (selectedRole.id == "student"){
            filterDesignations("student")
        }
        console.log(selectedRole.id)  
        
        const selectedDesignation = document.querySelector('input[type="radio"][name="designation"]:checked');

        if (selectedDesignation.id == "medical"){
            filterAllocation("medical")
        } else if (selectedDesignation.id == "nursing") {
            filterAllocation("nursing")
        
       }
       console.log(selectedDesignation.id)  */

    }
    

    function validateForm() {
       
        return true;
    }

    
    
    function filterDesignations(id) {
            var options = document.getElementsByName("designationOptions");
            for (var i = 0, length = options.length; i < length; i++) {
                if (options[i].dataset.id != id) {
                    options[i].style.display = "none";
                } else {
                    options[i].style.display = "block";
                }
            }
        }

        function filterAllocation(classification){
            var options = document.getElementsByName("allocationOptions");
            for (var i = 0, length = options.length; i < length; i++) {
                if (options[i].dataset.id != classification) {
                    options[i].style.display = "none";
                } else {
                    options[i].style.display = "block";
                }
            }
        }

//function that filters teams and wards based on department

var departments = {{ departments | default({}, true) | tojson | safe }};
    const designationAllocation = {{ designation_allocation | default({}, true) | tojson | safe }};
    const departmentsInfo = {{ departments_info | default({}, true) | tojson | safe }};

    let selectedDesignation = null;
    let selectedDepartment = null;

    function filterAllocation(role) {
        const selected = document.querySelector("input[name='designation']:checked");
        if (selected) {
            selectedDesignation = selected.value;
            updateAllocations();
        }
    }

    function showWards(department) {
        selectedDepartment = department;
        updateAllocations();
    }


function updateAllocations() {
    const allocationContainer = document.getElementById("allocationContainer");

    if (!selectedDesignation || !selectedDepartment) {
        allocationContainer.innerHTML = "<p>Please select both a designation and a department.</p>";
        return;
    }

    const allocationType = designationAllocation[selectedDesignation];
    const departmentData = departmentsInfo[selectedDepartment];

    if (!departmentData || !departmentData[allocationType]) {
        allocationContainer.innerHTML = `<p>No ${allocationType} available for ${selectedDepartment}.</p>`;
        return;
    }

    const items = departmentData[allocationType];
    const nameAttr = allocationType === 'teams' ? 'team' : 'wardAllocation';

    const htmlList = items.map(item => {
        const id = `${selectedDepartment.toLowerCase().replace(/ /g, '_')}_${item.value.toLowerCase().replace(/ /g, '_')}`;
        return `
            <li>
                <input type="radio" id="${id}" 
                       value="${item.value}" 
                       name="${nameAttr}" 
                       autocomplete="off">
                <label for="${id}">${item.label}</label>
                <div class="check"></div>
            </li>
        `;
    }).join('');

    allocationContainer.innerHTML = `
        <h3>${allocationType.charAt(0).toUpperCase() + allocationType.slice(1)} in ${selectedDepartment}</h3>
        <ul>${htmlList}</ul>
    `;
}

// set selectedDesignation and selectedDepartment on page load
document.addEventListener("DOMContentLoaded", function () {
    const checkedDesignation = document.querySelector('input[name="designation"]:checked');
    const checkedDepartment = document.querySelector('input[name="department"]:checked');

    if (checkedDesignation) {
        selectedDesignation = checkedDesignation.value;
    }

    if (checkedDepartment) {
        selectedDepartment = checkedDepartment.value;
    }

    if (selectedDesignation && selectedDepartment) {
        updateAllocations(); // Runs once with existing checked values
    }
});


</script>
{% endblock %}





